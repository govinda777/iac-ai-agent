# Makefile para Testes de IntegraÃ§Ã£o NFT Access

.PHONY: test-integration test-nation-pass test-contracts test-startup test-all help

# Cores para output
GREEN=\033[0;32m
YELLOW=\033[1;33m
RED=\033[0;31m
NC=\033[0m # No Color

# ConfiguraÃ§Ãµes padrÃ£o
TEST_TIMEOUT=30s
VERBOSE=-v

help: ## Mostra esta ajuda
	@echo "$(GREEN)Testes de IntegraÃ§Ã£o NFT Access - Nation Pass$(NC)"
	@echo ""
	@echo "$(YELLOW)Comandos disponÃ­veis:$(NC)"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  $(GREEN)%-20s$(NC) %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""
	@echo "$(YELLOW)VariÃ¡veis de ambiente necessÃ¡rias:$(NC)"
	@echo "  WALLET_ADDRESS        - Wallet com NFT Nation Pass"
	@echo "  NATION_NFT_CONTRACT   - EndereÃ§o do contrato Nation Pass"
	@echo "  BASE_RPC_URL          - RPC da Base Network"
	@echo ""
	@echo "$(YELLOW)Exemplo de uso:$(NC)"
	@echo "  make test-integration"
	@echo "  make test-nation-pass"
	@echo "  make test-all"

test-integration: ## Executa testes bÃ¡sicos de integraÃ§Ã£o
	@echo "$(GREEN)ðŸ§ª Executando testes bÃ¡sicos de integraÃ§Ã£o...$(NC)"
	@INTEGRATION_TESTS=true go test ./test/integration/ $(VERBOSE) -run "TestNFTAccessIntegration" -timeout $(TEST_TIMEOUT)

test-contracts: ## Executa testes com contratos reais
	@echo "$(GREEN)ðŸ”— Executando testes com contratos reais...$(NC)"
	@REAL_CONTRACT_TESTS=true go test ./test/integration/ $(VERBOSE) -run "TestNFTAccessManagerRealContract" -timeout $(TEST_TIMEOUT)

test-nation-pass: ## Executa testes especÃ­ficos Nation Pass
	@echo "$(GREEN)ðŸŽ¨ Executando testes especÃ­ficos Nation Pass...$(NC)"
	@NATION_PASS_TESTS=true go test ./test/integration/ $(VERBOSE) -run "TestNationPassAccessValidation" -timeout $(TEST_TIMEOUT)

test-startup: ## Executa testes de validaÃ§Ã£o de startup
	@echo "$(GREEN)ðŸš€ Executando testes de validaÃ§Ã£o de startup...$(NC)"
	@STARTUP_VALIDATION_TESTS=true go test ./test/integration/ $(VERBOSE) -run "TestStartupValidationIntegration" -timeout $(TEST_TIMEOUT)

test-tiers: ## Executa testes de validaÃ§Ã£o de tiers
	@echo "$(GREEN)ðŸ“Š Executando testes de validaÃ§Ã£o de tiers...$(NC)"
	@TIER_VALIDATION_TESTS=true go test ./test/integration/ $(VERBOSE) -run "TestNationPassTierValidation" -timeout $(TEST_TIMEOUT)

test-flow: ## Executa testes de fluxo completo
	@echo "$(GREEN)ðŸ”„ Executando testes de fluxo completo...$(NC)"
	@NATION_PASS_FLOW_TESTS=true go test ./test/integration/ $(VERBOSE) -run "TestNationPassIntegrationFlow" -timeout $(TEST_TIMEOUT)

test-all: ## Executa todos os testes de integraÃ§Ã£o
	@echo "$(GREEN)ðŸŽ¯ Executando todos os testes de integraÃ§Ã£o...$(NC)"
	@INTEGRATION_TESTS=true REAL_CONTRACT_TESTS=true NATION_PASS_TESTS=true STARTUP_VALIDATION_TESTS=true TIER_VALIDATION_TESTS=true NATION_PASS_FLOW_TESTS=true go test ./test/integration/ $(VERBOSE) -timeout $(TEST_TIMEOUT)

test-quick: ## Executa apenas testes bÃ¡sicos (mais rÃ¡pidos)
	@echo "$(GREEN)âš¡ Executando testes rÃ¡pidos...$(NC)"
	@INTEGRATION_TESTS=true go test ./test/integration/ $(VERBOSE) -run "TestNFTAccessIntegration" -timeout 10s

test-verbose: ## Executa testes com output detalhado
	@echo "$(GREEN)ðŸ“ Executando testes com output detalhado...$(NC)"
	@INTEGRATION_TESTS=true REAL_CONTRACT_TESTS=true NATION_PASS_TESTS=true go test ./test/integration/ -v -timeout $(TEST_TIMEOUT)

check-env: ## Verifica se as variÃ¡veis de ambiente estÃ£o configuradas
	@echo "$(GREEN)ðŸ” Verificando variÃ¡veis de ambiente...$(NC)"
	@if [ -z "$$WALLET_ADDRESS" ]; then echo "$(RED)âŒ WALLET_ADDRESS nÃ£o configurada$(NC)"; exit 1; fi
	@if [ -z "$$NATION_NFT_CONTRACT" ]; then echo "$(RED)âŒ NATION_NFT_CONTRACT nÃ£o configurada$(NC)"; exit 1; fi
	@if [ -z "$$BASE_RPC_URL" ]; then echo "$(RED)âŒ BASE_RPC_URL nÃ£o configurada$(NC)"; exit 1; fi
	@echo "$(GREEN)âœ… Todas as variÃ¡veis obrigatÃ³rias estÃ£o configuradas$(NC)"

setup-test-env: ## Configura ambiente de teste
	@echo "$(GREEN)âš™ï¸ Configurando ambiente de teste...$(NC)"
	@if [ ! -f ".env" ]; then \
		echo "$(YELLOW)âš ï¸ Arquivo .env nÃ£o encontrado, copiando env.example...$(NC)"; \
		cp env.example .env; \
		echo "$(YELLOW)âš ï¸ Configure suas variÃ¡veis no arquivo .env$(NC)"; \
	else \
		echo "$(GREEN)âœ… Arquivo .env encontrado$(NC)"; \
	fi

clean-test-cache: ## Limpa cache de testes
	@echo "$(GREEN)ðŸ§¹ Limpando cache de testes...$(NC)"
	@go clean -testcache
	@go clean -cache

test-coverage: ## Executa testes com cobertura
	@echo "$(GREEN)ðŸ“Š Executando testes com cobertura...$(NC)"
	@INTEGRATION_TESTS=true REAL_CONTRACT_TESTS=true NATION_PASS_TESTS=true go test ./test/integration/ -cover -coverprofile=coverage.out
	@go tool cover -html=coverage.out -o coverage.html
	@echo "$(GREEN)âœ… RelatÃ³rio de cobertura gerado: coverage.html$(NC)"

test-benchmark: ## Executa benchmarks de performance
	@echo "$(GREEN)ðŸƒ Executando benchmarks...$(NC)"
	@INTEGRATION_TESTS=true go test ./test/integration/ -bench=. -benchmem

test-race: ## Executa testes com detecÃ§Ã£o de race conditions
	@echo "$(GREEN)ðŸ Executando testes com detecÃ§Ã£o de race conditions...$(NC)"
	@INTEGRATION_TESTS=true go test ./test/integration/ -race -timeout $(TEST_TIMEOUT)

# Comandos de desenvolvimento
dev-setup: ## Configura ambiente de desenvolvimento
	@echo "$(GREEN)ðŸ› ï¸ Configurando ambiente de desenvolvimento...$(NC)"
	@make setup-test-env
	@make check-env
	@echo "$(GREEN)âœ… Ambiente de desenvolvimento configurado$(NC)"

dev-test: ## Executa testes de desenvolvimento (rÃ¡pidos)
	@echo "$(GREEN)ðŸ”§ Executando testes de desenvolvimento...$(NC)"
	@make test-quick

# Comandos de CI/CD
ci-test: ## Executa testes para CI/CD
	@echo "$(GREEN)ðŸ¤– Executando testes para CI/CD...$(NC)"
	@make test-all

ci-test-quick: ## Executa testes rÃ¡pidos para CI/CD
	@echo "$(GREEN)âš¡ Executando testes rÃ¡pidos para CI/CD...$(NC)"
	@make test-quick

# Comandos de produÃ§Ã£o
prod-test: ## Executa testes de produÃ§Ã£o (completos)
	@echo "$(GREEN)ðŸ­ Executando testes de produÃ§Ã£o...$(NC)"
	@make test-all
	@make test-coverage

# Comandos de troubleshooting
debug-test: ## Executa testes em modo debug
	@echo "$(GREEN)ðŸ› Executando testes em modo debug...$(NC)"
	@LOG_LEVEL=debug INTEGRATION_TESTS=true go test ./test/integration/ -v -timeout $(TEST_TIMEOUT)

test-specific: ## Executa teste especÃ­fico (use TEST_NAME=TestName)
	@echo "$(GREEN)ðŸŽ¯ Executando teste especÃ­fico: $(TEST_NAME)$(NC)"
	@INTEGRATION_TESTS=true go test ./test/integration/ $(VERBOSE) -run "$(TEST_NAME)" -timeout $(TEST_TIMEOUT)

# Comandos de documentaÃ§Ã£o
test-docs: ## Gera documentaÃ§Ã£o dos testes
	@echo "$(GREEN)ðŸ“š Gerando documentaÃ§Ã£o dos testes...$(NC)"
	@echo "Testes de IntegraÃ§Ã£o NFT Access - Nation Pass" > test-results.md
	@echo "=============================================" >> test-results.md
	@echo "" >> test-results.md
	@echo "Executado em: $$(date)" >> test-results.md
	@echo "" >> test-results.md
	@make test-all >> test-results.md 2>&1
	@echo "$(GREEN)âœ… DocumentaÃ§Ã£o gerada: test-results.md$(NC)"

# Comandos de limpeza
clean: ## Limpa arquivos temporÃ¡rios
	@echo "$(GREEN)ðŸ§¹ Limpando arquivos temporÃ¡rios...$(NC)"
	@rm -f coverage.out coverage.html test-results.md
	@make clean-test-cache

# Comandos de verificaÃ§Ã£o
verify: ## Verifica se tudo estÃ¡ funcionando
	@echo "$(GREEN)âœ… Verificando sistema...$(NC)"
	@make check-env
	@make test-quick
	@echo "$(GREEN)ðŸŽ‰ Sistema funcionando corretamente!$(NC)"

# Comandos de status
status: ## Mostra status do sistema
	@echo "$(GREEN)ðŸ“Š Status do sistema:$(NC)"
	@echo "  Wallet Address: $$WALLET_ADDRESS"
	@echo "  Nation Contract: $$NATION_NFT_CONTRACT"
	@echo "  Base RPC: $$BASE_RPC_URL"
	@echo "  Go Version: $$(go version)"
	@echo "  Test Timeout: $(TEST_TIMEOUT)"
