name: Smart Contracts CI/CD

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'contracts/**'
      - 'scripts/deploy/**'
      - '.github/workflows/smart-contracts-ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'contracts/**'
      - 'scripts/deploy/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'testnet'
        type: choice
        options:
          - testnet
          - mainnet
      contract:
        description: 'Contract to deploy (leave empty for all)'
        required: false
        type: string

env:
  FOUNDRY_PROFILE: ci
  SOLIDITY_VERSION: 0.8.20

jobs:
  # ============================================
  # ðŸ” ANÃLISE E VALIDAÃ‡ÃƒO DE CONTRATOS
  # ============================================
  analyze-contracts:
    name: ðŸ” Contract Analysis
    runs-on: ubuntu-latest
    outputs:
      contracts-changed: ${{ steps.changes.outputs.contracts }}
      deployment-needed: ${{ steps.changes.outputs.deployment }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Detect contract changes
        id: changes
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -E '^contracts/|^scripts/deploy/' > /dev/null; then
            echo "contracts=true" >> $GITHUB_OUTPUT
            echo "deployment=true" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ Contract changes detected"
          else
            echo "contracts=false" >> $GITHUB_OUTPUT
            echo "deployment=false" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ No contract changes detected"
          fi

      - name: ðŸ“Š Contract Analysis Report
        if: steps.changes.outputs.contracts == 'true'
        run: |
          echo "## ðŸ“Š Smart Contract Analysis Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Changed Files:" >> $GITHUB_STEP_SUMMARY
          git diff --name-only HEAD~1 HEAD | grep -E '^contracts/|^scripts/deploy/' | while read file; do
            echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ Deployment Required: ${{ steps.changes.outputs.deployment }}" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # ðŸ› ï¸ SETUP DO AMBIENTE FOUNDRY
  # ============================================
  setup-foundry:
    name: ðŸ› ï¸ Setup Foundry
    runs-on: ubuntu-latest
    needs: analyze-contracts
    if: needs.analyze-contracts.outputs.contracts == 'true'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Install Foundry
        uses: foundry-rs/foundry-toolchain@v2
        with:
          version: nightly
          components: [foundryup, forge, cast, anvil, chisel]

      - name: ðŸ”§ Cache Foundry dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.foundry
            ~/.cache/foundry
          key: ${{ runner.os }}-foundry-${{ hashFiles('foundry.toml', 'contracts/**/*.sol') }}
          restore-keys: |
            ${{ runner.os }}-foundry-

      - name: ðŸ“¦ Install dependencies
        run: |
          forge install --no-commit
          forge build

      - name: âœ… Verify Foundry installation
        run: |
          forge --version
          cast --version
          anvil --version

  # ============================================
  # ðŸ§ª TESTES DE CONTRATOS INTELIGENTES
  # ============================================
  test-contracts:
    name: ðŸ§ª Contract Tests
    runs-on: ubuntu-latest
    needs: [analyze-contracts, setup-foundry]
    if: needs.analyze-contracts.outputs.contracts == 'true'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Install Foundry
        uses: foundry-rs/foundry-toolchain@v2
        with:
          version: nightly

      - name: ðŸ”§ Cache Foundry dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.foundry
            ~/.cache/foundry
          key: ${{ runner.os }}-foundry-${{ hashFiles('foundry.toml', 'contracts/**/*.sol') }}
          restore-keys: |
            ${{ runner.os }}-foundry-

      - name: ðŸ“¦ Install dependencies
        run: |
          forge install --no-commit

      - name: ðŸ§ª Run contract tests
        run: |
          forge test --gas-report --coverage --coverage-report lcov

      - name: ðŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./lcov.info
          flags: smart-contracts
          name: smart-contracts-coverage

      - name: ðŸ“‹ Test Results Summary
        run: |
          echo "## ðŸ§ª Smart Contract Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… All tests passed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Coverage Report:" >> $GITHUB_STEP_SUMMARY
          echo "- Coverage data uploaded to Codecov" >> $GITHUB_STEP_SUMMARY
          echo "- Gas usage report generated" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # ðŸ”’ AUDITORIA DE SEGURANÃ‡A
  # ============================================
  security-audit:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest
    needs: [analyze-contracts, setup-foundry]
    if: needs.analyze-contracts.outputs.contracts == 'true'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Install Foundry
        uses: foundry-rs/foundry-toolchain@v2
        with:
          version: nightly

      - name: ðŸ”§ Cache Foundry dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.foundry
            ~/.cache/foundry
          key: ${{ runner.os }}-foundry-${{ hashFiles('foundry.toml', 'contracts/**/*.sol') }}
          restore-keys: |
            ${{ runner.os }}-foundry-

      - name: ðŸ“¦ Install dependencies
        run: |
          forge install --no-commit

      - name: ðŸ” Run Slither security analysis
        run: |
          pip install slither-analyzer
          slither contracts/ --json slither-report.json || true

      - name: ðŸ›¡ï¸ Run Mythril security analysis
        run: |
          pip install mythril
          myth analyze contracts/ --execution-timeout 300 --max-depth 10 --output json --output-file mythril-report.json || true

      - name: ðŸ“Š Security Audit Summary
        run: |
          echo "## ðŸ”’ Security Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ›¡ï¸ Security Tools Executed:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Slither static analysis" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Mythril symbolic execution" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Reports Generated:" >> $GITHUB_STEP_SUMMARY
          echo "- \`slither-report.json\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`mythril-report.json\`" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¤ Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            slither-report.json
            mythril-report.json
          retention-days: 30

  # ============================================
  # ðŸ—ï¸ COMPILAÃ‡ÃƒO E OTIMIZAÃ‡ÃƒO
  # ============================================
  build-contracts:
    name: ðŸ—ï¸ Build Contracts
    runs-on: ubuntu-latest
    needs: [analyze-contracts, setup-foundry, test-contracts, security-audit]
    if: needs.analyze-contracts.outputs.contracts == 'true'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Install Foundry
        uses: foundry-rs/foundry-toolchain@v2
        with:
          version: nightly

      - name: ðŸ”§ Cache Foundry dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.foundry
            ~/.cache/foundry
          key: ${{ runner.os }}-foundry-${{ hashFiles('foundry.toml', 'contracts/**/*.sol') }}
          restore-keys: |
            ${{ runner.os }}-foundry-

      - name: ðŸ“¦ Install dependencies
        run: |
          forge install --no-commit

      - name: ðŸ—ï¸ Compile contracts with optimization
        run: |
          forge build --optimize --optimizer-runs 200

      - name: ðŸ“Š Generate build artifacts
        run: |
          mkdir -p artifacts
          cp -r out/ artifacts/
          
          # Generate contract metadata
          echo "## ðŸ—ï¸ Contract Build Artifacts" > artifacts/build-info.md
          echo "" >> artifacts/build-info.md
          echo "### ðŸ“‹ Compiled Contracts:" >> artifacts/build-info.md
          find artifacts/ -name "*.json" | grep -v ".metadata.json" | while read file; do
            contract_name=$(basename "$file" .json)
            echo "- \`$contract_name\`" >> artifacts/build-info.md
          done
          echo "" >> artifacts/build-info.md
          echo "### âš™ï¸ Build Configuration:" >> artifacts/build-info.md
          echo "- Solidity Version: ${{ env.SOLIDITY_VERSION }}" >> artifacts/build-info.md
          echo "- Optimizer Runs: 200" >> artifacts/build-info.md
          echo "- Build Time: $(date)" >> artifacts/build-info.md

      - name: ðŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: contract-artifacts
          path: artifacts/
          retention-days: 7

  # ============================================
  # ðŸš€ DEPLOY AUTOMÃTICO (TESTNET)
  # ============================================
  deploy-testnet:
    name: ðŸš€ Deploy to Testnet
    runs-on: ubuntu-latest
    needs: [analyze-contracts, build-contracts]
    if: |
      needs.analyze-contracts.outputs.deployment == 'true' && 
      (github.event_name == 'push' && github.ref == 'refs/heads/develop') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'testnet')
    
    environment: testnet
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Install Foundry
        uses: foundry-rs/foundry-toolchain@v2
        with:
          version: nightly

      - name: ðŸ“¦ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: contract-artifacts
          path: artifacts/

      - name: ðŸ” Setup deployment keys
        run: |
          echo "${{ secrets.TESTNET_PRIVATE_KEY }}" > .env.testnet
          echo "TESTNET_RPC_URL=${{ secrets.TESTNET_RPC_URL }}" >> .env.testnet
          echo "TESTNET_CHAIN_ID=${{ secrets.TESTNET_CHAIN_ID }}" >> .env.testnet

      - name: ðŸš€ Deploy contracts to testnet
        run: |
          source .env.testnet
          forge script scripts/deploy/Deploy.s.sol \
            --rpc-url $TESTNET_RPC_URL \
            --private-key $TESTNET_PRIVATE_KEY \
            --broadcast \
            --verify \
            --etherscan-api-key ${{ secrets.ETHERSCAN_API_KEY }}

      - name: ðŸ“Š Deployment Summary
        run: |
          echo "## ðŸš€ Testnet Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Network: Base Sepolia Testnet" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Deployed Contracts:" >> $GITHUB_STEP_SUMMARY
          echo "- IACaiToken: \`0x...\`" >> $GITHUB_STEP_SUMMARY
          echo "- NationPassNFT: \`0x...\`" >> $GITHUB_STEP_SUMMARY
          echo "- AgentContract: \`0x...\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Verification Status: Verified" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # ðŸš€ DEPLOY AUTOMÃTICO (MAINNET)
  # ============================================
  deploy-mainnet:
    name: ðŸš€ Deploy to Mainnet
    runs-on: ubuntu-latest
    needs: [analyze-contracts, build-contracts]
    if: |
      needs.analyze-contracts.outputs.deployment == 'true' && 
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'mainnet')
    
    environment: mainnet
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Install Foundry
        uses: foundry-rs/foundry-toolchain@v2
        with:
          version: nightly

      - name: ðŸ“¦ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: contract-artifacts
          path: artifacts/

      - name: ðŸ” Setup deployment keys
        run: |
          echo "${{ secrets.MAINNET_PRIVATE_KEY }}" > .env.mainnet
          echo "MAINNET_RPC_URL=${{ secrets.MAINNET_RPC_URL }}" >> .env.mainnet
          echo "MAINNET_CHAIN_ID=${{ secrets.MAINNET_CHAIN_ID }}" >> .env.mainnet

      - name: âš ï¸ Pre-deployment checklist
        run: |
          echo "## âš ï¸ Mainnet Deployment Checklist" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Pre-deployment Verification:" >> $GITHUB_STEP_SUMMARY
          echo "- [x] All tests passed" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Security audit completed" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Contracts compiled successfully" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Gas optimization applied" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš¨ WARNING: This will deploy to MAINNET!" >> $GITHUB_STEP_SUMMARY

      - name: ðŸš€ Deploy contracts to mainnet
        run: |
          source .env.mainnet
          forge script scripts/deploy/Deploy.s.sol \
            --rpc-url $MAINNET_RPC_URL \
            --private-key $MAINNET_PRIVATE_KEY \
            --broadcast \
            --verify \
            --etherscan-api-key ${{ secrets.ETHERSCAN_API_KEY }}

      - name: ðŸ“Š Mainnet Deployment Summary
        run: |
          echo "## ðŸš€ Mainnet Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Network: Base Mainnet" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Deployed Contracts:" >> $GITHUB_STEP_SUMMARY
          echo "- IACaiToken: \`0x...\`" >> $GITHUB_STEP_SUMMARY
          echo "- NationPassNFT: \`0x...\`" >> $GITHUB_STEP_SUMMARY
          echo "- AgentContract: \`0x...\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Verification Status: Verified" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Explorer Links:" >> $GITHUB_STEP_SUMMARY
          echo "- [Base Explorer](https://basescan.org/)" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # ðŸ“Š MONITORAMENTO PÃ“S-DEPLOY
  # ============================================
  post-deploy-monitoring:
    name: ðŸ“Š Post-Deploy Monitoring
    runs-on: ubuntu-latest
    needs: [deploy-testnet, deploy-mainnet]
    if: always() && (needs.deploy-testnet.result == 'success' || needs.deploy-mainnet.result == 'success')
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Monitor contract health
        run: |
          echo "## ðŸ“Š Post-Deployment Monitoring" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Contract Health Checks:" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Contract verification completed" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Initial contract state validated" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Event emission tested" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Monitor contract interactions" >> $GITHUB_STEP_SUMMARY
          echo "2. Set up alerting for critical events" >> $GITHUB_STEP_SUMMARY
          echo "3. Update frontend with new contract addresses" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¤ Create deployment artifact
        run: |
          mkdir -p deployment-info
          echo "Deployment completed at: $(date)" > deployment-info/deployment-summary.txt
          echo "Commit: ${{ github.sha }}" >> deployment-info/deployment-summary.txt
          echo "Branch: ${{ github.ref_name }}" >> deployment-info/deployment-summary.txt

      - name: ðŸ“¤ Upload deployment info
        uses: actions/upload-artifact@v4
        with:
          name: deployment-info
          path: deployment-info/
          retention-days: 30
