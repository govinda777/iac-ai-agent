#!/bin/bash

# Pre-commit hook: Executa testes unitÃ¡rios
# Para pular os testes temporariamente: git commit --no-verify

set -e

echo ""
echo "ğŸ” =================================="
echo "ğŸ” PRE-COMMIT: Executando Testes UnitÃ¡rios"
echo "ğŸ” =================================="
echo ""

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get current branch
BRANCH=$(git rev-parse --abbrev-ref HEAD)
echo -e "${BLUE}Branch: ${BRANCH}${NC}"
echo ""

# ============================================
# 1. FORMAT CHECK
# ============================================
echo -e "${YELLOW}ğŸ“‹ [1/3] Verificando formataÃ§Ã£o do cÃ³digo...${NC}"
if ! make fmt; then
    echo -e "${RED}âŒ FormataÃ§Ã£o do cÃ³digo falhou!${NC}"
    echo ""
    echo "ğŸ’¡ Dica: Execute 'make fmt' para corrigir automaticamente"
    exit 1
fi
echo -e "${GREEN}âœ… FormataÃ§Ã£o do cÃ³digo OK!${NC}"
echo ""

# ============================================
# 2. TESTES UNITÃRIOS
# ============================================
echo -e "${YELLOW}ğŸ§ª [2/3] Executando Testes UnitÃ¡rios...${NC}"

# Configurar PATH para incluir GOPATH/bin
export PATH=$PATH:$(go env GOPATH)/bin

if ! make test-unit; then
    echo -e "${RED}âŒ Testes unitÃ¡rios falharam!${NC}"
    echo ""
    echo "ğŸ’¡ Dica: Execute 'make test-unit' para ver detalhes"
    exit 1
fi
echo -e "${GREEN}âœ… Testes unitÃ¡rios passaram!${NC}"
echo ""

# ============================================
# 3. BUILD CHECK
# ============================================
echo -e "${YELLOW}ğŸ—ï¸  [3/4] Verificando Build...${NC}"
if ! make build; then
    echo -e "${RED}âŒ Build falhou!${NC}"
    echo ""
    echo "ğŸ’¡ Dica: Execute 'make build' para ver detalhes"
    exit 1
fi
echo -e "${GREEN}âœ… Build passou!${NC}"
echo ""

# ============================================
# 4. GERAR RELATÃ“RIO DE QUALIDADE (TEMPORARIAMENTE DESABILITADO)
# ============================================
echo -e "${YELLOW}ğŸ“Š [4/4] Gerando RelatÃ³rio de Qualidade...${NC}"
echo -e "${YELLOW}âš ï¸  RelatÃ³rio HTML temporariamente desabilitado para evitar travamento${NC}"
# if ! go run scripts/generate_report.go unit; then
#     echo -e "${RED}âŒ GeraÃ§Ã£o de relatÃ³rio falhou!${NC}"
#     echo ""
#     echo "ğŸ’¡ Dica: Execute 'go run scripts/generate_report.go unit' para ver detalhes"
#     exit 1
# fi
echo -e "${GREEN}âœ… RelatÃ³rio de qualidade pulado (temporariamente)!${NC}"
echo ""

# ============================================
# SUCCESS
# ============================================
echo -e "${GREEN}ğŸ‰ =================================="
echo -e "ğŸ‰ TESTES UNITÃRIOS PASSARAM!"
echo -e "ğŸ‰ ==================================${NC}"
echo ""
echo -e "${BLUE}ğŸ“¦ Prosseguindo com commit...${NC}"
echo ""

exit 0
