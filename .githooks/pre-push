#!/bin/bash

# Pre-push hook: Executa testes unitÃ¡rios e de integraÃ§Ã£o
# Para pular os testes temporariamente: git push --no-verify

set -e

echo ""
echo "ğŸ” =================================="
echo "ğŸ” PRE-PUSH: Executando Testes"
echo "ğŸ” =================================="
echo ""

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get current branch
BRANCH=$(git rev-parse --abbrev-ref HEAD)
echo -e "${BLUE}Branch: ${BRANCH}${NC}"
echo ""

# ============================================
# 1. LINTER
# ============================================
echo -e "${YELLOW}ğŸ“‹ [1/4] Executando Linter...${NC}"
if which golangci-lint > /dev/null; then
    if ! make lint; then
        echo -e "${RED}âŒ Linter falhou! Corrija os erros antes do push.${NC}"
        echo ""
        echo "ğŸ’¡ Dica: Execute 'make lint' para ver os erros"
        exit 1
    fi
    echo -e "${GREEN}âœ… Linter passou!${NC}"
else
    echo -e "${YELLOW}âš ï¸  golangci-lint nÃ£o estÃ¡ instalado. Pulando verificaÃ§Ã£o.${NC}"
    echo -e "${YELLOW}ğŸ’¡ Para instalar: 'make lint-install' ou 'brew install golangci-lint'${NC}"
fi
echo ""

# ============================================
# 2. TESTES UNITÃRIOS
# ============================================
echo -e "${YELLOW}ğŸ§ª [2/4] Executando Testes UnitÃ¡rios...${NC}"
if ! make test-unit; then
    echo -e "${RED}âŒ Testes unitÃ¡rios falharam!${NC}"
    echo ""
    echo "ğŸ’¡ Dica: Execute 'make test-unit' para ver detalhes"
    exit 1
fi
echo -e "${GREEN}âœ… Testes unitÃ¡rios passaram!${NC}"
echo ""

# ============================================
# 3. TESTES DE INTEGRAÃ‡ÃƒO
# ============================================
echo -e "${YELLOW}ğŸ”— [3/4] Executando Testes de IntegraÃ§Ã£o...${NC}"
if ! make test-integration; then
    echo -e "${RED}âŒ Testes de integraÃ§Ã£o falharam!${NC}"
    echo ""
    echo "ğŸ’¡ Dica: Execute 'make test-integration' para ver detalhes"
    exit 1
fi
echo -e "${GREEN}âœ… Testes de integraÃ§Ã£o passaram!${NC}"
echo ""

# ============================================
# 4. TESTES BDD
# ============================================
echo -e "${YELLOW}ğŸ” [4/5] Executando Testes BDD...${NC}"

# Configurar PATH para incluir GOPATH/bin
export PATH=$PATH:$(go env GOPATH)/bin

if ! make test-bdd; then
    echo -e "${RED}âŒ Testes BDD falharam!${NC}"
    echo ""
    echo "ğŸ’¡ Dica: Execute 'make test-bdd' para ver detalhes"
    exit 1
fi
echo -e "${GREEN}âœ… Testes BDD passaram!${NC}"
echo ""

# ============================================
# 5. BUILD
# ============================================
echo -e "${YELLOW}ğŸ—ï¸  [5/6] Verificando Build...${NC}"
if ! make build; then
    echo -e "${RED}âŒ Build falhou!${NC}"
    echo ""
    echo "ğŸ’¡ Dica: Execute 'make build' para ver detalhes"
    exit 1
fi
echo -e "${GREEN}âœ… Build passou!${NC}"
echo ""

# ============================================
# 6. GERAR E VERSIONAR RELATÃ“RIOS
# ============================================
echo -e "${YELLOW}ğŸ“Š [6/6] Gerando e Versionando RelatÃ³rios de Qualidade...${NC}"

# Gerar relatÃ³rio completo
if ! go run scripts/generate_report.go all; then
    echo -e "${RED}âŒ GeraÃ§Ã£o de relatÃ³rio falhou!${NC}"
    echo ""
    echo "ğŸ’¡ Dica: Execute 'go run scripts/generate_report.go all' para ver detalhes"
    exit 1
fi

# Versionar relatÃ³rios para Git
if ! ./scripts/version_reports.sh; then
    echo -e "${RED}âŒ Versionamento de relatÃ³rios falhou!${NC}"
    echo ""
    echo "ğŸ’¡ Dica: Execute './scripts/version_reports.sh' para ver detalhes"
    exit 1
fi

echo -e "${GREEN}âœ… RelatÃ³rios de qualidade gerados e versionados!${NC}"
echo ""

# ============================================
# SUCCESS
# ============================================
echo -e "${GREEN}ğŸ‰ =================================="
echo -e "ğŸ‰ TODOS OS TESTES PASSARAM!"
echo -e "ğŸ‰ ==================================${NC}"
echo ""
echo -e "${BLUE}ğŸ“¦ Prosseguindo com push...${NC}"
echo ""

exit 0
